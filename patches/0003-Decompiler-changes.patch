From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Jason Penilla <11360596+jpenilla@users.noreply.github.com>
Date: Thu, 1 Jul 2021 22:01:14 -0700
Subject: [PATCH] Decompiler changes


diff --git a/build.gradle b/build.gradle
index 0e75c3fcaf8ef66f8465efca4456de27a615f2aa..ac7078a71c4e05aec563d42bacb942d8f23e8829 100644
--- a/build.gradle
+++ b/build.gradle
@@ -91,7 +91,11 @@ dependencies {
 	}
 
 	// decompilers
-	implementation ('net.fabricmc:fabric-fernflower:2.0.0')
+	// quiet start
+	implementation("org.vineflower:vineflower:1.9.1") {
+		transitive = false
+	}
+	// quiet end
 	implementation ('net.fabricmc:cfr:0.2.0')
 
 	// source code remapping
diff --git a/src/main/java/net/fabricmc/loom/configuration/decompile/SingleJarDecompileConfiguration.java b/src/main/java/net/fabricmc/loom/configuration/decompile/SingleJarDecompileConfiguration.java
index 6fa25b5c570d6db178453bfa386fd863fdcfc490..c97d5bcf0c6f6f18a9852aaf17e5c68376e480d7 100644
--- a/src/main/java/net/fabricmc/loom/configuration/decompile/SingleJarDecompileConfiguration.java
+++ b/src/main/java/net/fabricmc/loom/configuration/decompile/SingleJarDecompileConfiguration.java
@@ -79,7 +79,7 @@ public class SingleJarDecompileConfiguration extends DecompileConfiguration<Mapp
 			task.setDescription("Decompile minecraft using the default decompiler.");
 			task.setGroup(Constants.TaskGroup.FABRIC);
 
-			task.dependsOn(project.getTasks().named("genSourcesWithCfr"));
+			task.dependsOn(project.getTasks().named("genSourcesWithVineflower")); // quiet
 		});
 	}
 }
diff --git a/src/main/java/net/fabricmc/loom/decompilers/DecompilerConfiguration.java b/src/main/java/net/fabricmc/loom/decompilers/DecompilerConfiguration.java
index adf8650d40c3deaa22c0f6c91ae4a1520fa93bf3..39f2b804c160110a1de13253934b648d8243b9f9 100644
--- a/src/main/java/net/fabricmc/loom/decompilers/DecompilerConfiguration.java
+++ b/src/main/java/net/fabricmc/loom/decompilers/DecompilerConfiguration.java
@@ -39,7 +39,7 @@ public abstract class DecompilerConfiguration implements Runnable {
 
 	@Override
 	public void run() {
-		registerDecompiler(getProject(), "fernFlower", FabricFernFlowerDecompiler.class);
+		registerDecompiler(getProject(), "vineflower", FabricFernFlowerDecompiler.class); // quiet
 		registerDecompiler(getProject(), "cfr", LoomCFRDecompiler.class);
 	}
 
diff --git a/src/main/java/net/fabricmc/loom/decompilers/fernflower/FabricFernFlowerDecompiler.java b/src/main/java/net/fabricmc/loom/decompilers/fernflower/FabricFernFlowerDecompiler.java
index 2d2041b6fea5697d72c4c2c8ff3b43fe47101fa1..a8e6eef94935fbcff5f12a66368230f7455704c7 100644
--- a/src/main/java/net/fabricmc/loom/decompilers/fernflower/FabricFernFlowerDecompiler.java
+++ b/src/main/java/net/fabricmc/loom/decompilers/fernflower/FabricFernFlowerDecompiler.java
@@ -44,9 +44,9 @@ public final class FabricFernFlowerDecompiler implements LoomDecompiler {
 					IFernflowerPreferences.DECOMPILE_GENERIC_SIGNATURES, "1",
 					IFernflowerPreferences.BYTECODE_SOURCE_MAPPING, "1",
 					IFernflowerPreferences.REMOVE_SYNTHETIC, "1",
-					IFernflowerPreferences.LOG_LEVEL, "trace",
+					IFernflowerPreferences.LOG_LEVEL, "warn", // quiet
 					IFernflowerPreferences.THREADS, String.valueOf(metaData.numberOfThreads()),
-					IFernflowerPreferences.INDENT_STRING, "\t",
+					IFernflowerPreferences.INDENT_STRING, "  ", // quiet
 					IFabricJavadocProvider.PROPERTY_NAME, new TinyJavadocProvider(metaData.javaDocs().toFile())
 				)
 		);
diff --git a/src/test/groovy/net/fabricmc/loom/test/integration/DecompileTest.groovy b/src/test/groovy/net/fabricmc/loom/test/integration/DecompileTest.groovy
index 5b2f0e105991b8493ca4473a0570cd7457156c07..e79ffd0bf856f58851a18216ea2e627057a9208e 100644
--- a/src/test/groovy/net/fabricmc/loom/test/integration/DecompileTest.groovy
+++ b/src/test/groovy/net/fabricmc/loom/test/integration/DecompileTest.groovy
@@ -46,7 +46,7 @@ class DecompileTest extends Specification implements GradleProjectTestTrait {
 
 		where:
 		decompiler 		| task								| version
-		'fernflower'	| "genSourcesWithFernFlower"		| PRE_RELEASE_GRADLE
+		'vineflower'	| "genSourcesWithVineflower"		| PRE_RELEASE_GRADLE // quiet
 		'cfr' 			| "genSourcesWithCfr"				| PRE_RELEASE_GRADLE
 	}
 
diff --git a/src/test/groovy/net/fabricmc/loom/test/integration/FabricAPITest.groovy b/src/test/groovy/net/fabricmc/loom/test/integration/FabricAPITest.groovy
index 037977ac0ee6a13452ea6b72e1d246d3e7ff7546..ba9f19b2b9408dff037ec569cf133fe39ed9c398 100644
--- a/src/test/groovy/net/fabricmc/loom/test/integration/FabricAPITest.groovy
+++ b/src/test/groovy/net/fabricmc/loom/test/integration/FabricAPITest.groovy
@@ -54,7 +54,7 @@ class FabricAPITest extends Specification implements GradleProjectTestTrait {
 
 		// Set the version to something constant
 		gradle.buildGradle.text = gradle.buildGradle.text.replace('project.version + "+" + (ENV.GITHUB_RUN_NUMBER ? "" : "local-") + getBranch()', "\"$API_VERSION\"")
-				.replace("fabric-loom", "quiet-fabric-loom") // quiet
+				.replace("fabric-loom", "quiet-fabric-loom").replace("FernFlower", "Vineflower") // quiet
 
 		def server = ServerRunner.create(gradle.projectDir, "1.19.4")
 				.withMod(gradle.getOutputFile("fabric-api-${API_VERSION}.jar"))
diff --git a/src/test/resources/projects/decompile/build.gradle b/src/test/resources/projects/decompile/build.gradle
index b38fc44fb5f10c691e2d01b6d1b1e97575ec5f38..cf9e1b88b86cae9b92c9f5dd7226fa8fa3495243 100644
--- a/src/test/resources/projects/decompile/build.gradle
+++ b/src/test/resources/projects/decompile/build.gradle
@@ -13,7 +13,7 @@ loom {
 		cfr {
 			options.put("test", "value")
 		}
-		fernflower {
+		vineflower { // quiet
 			options.put("test", "value")
 		}
 	}
